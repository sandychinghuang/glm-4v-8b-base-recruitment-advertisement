import pandas as pd
import json

def xlsx_to_jsonl(file_path, output_path):
    """
    將 Excel 數據轉換保存為 JSONL 格式，並保存到指定文件。
    
    Args:
        file_path (str): Excel 文件路径。
        output_path (str): 輸出 JSONL 文件路徑。
    """
    # 读取 Excel 文件
    data = pd.read_excel(file_path)
    
    with open(output_path, 'w', encoding='utf-8') as f:
        for _, row in data.iterrows():
            # 用户信息
            user_message = {
                "role": "user",
                "content": """
        現在你是一位徵才資訊分類達人，請你詳細描述完整，包括廣告中出現的所有文字和訊息，沒有出現的請不要擅自加入，若無該欄位資請填'無'。 
        -請首先找到公司名稱、聯絡電話、公司地址。公司名稱為可能的公司名稱、店名、單位、廠房名稱、工作性質等，請寫完整，不要刪字，真的沒有才填'無'。每個聯絡電話只可包含電話(有分機請加在電話後面，例如'分機11')，若不同區域有不同電話，請特別註明區域與電話，勿加入與職位和工作無關的資訊，例如'誠徵'、'Line Id'、'意洽'、'鄭經理'、'陳小姐'、'孫先生'等。公司地址不一定是完整地址，只要可能為公司位置的地名都可寫，若出現括號，例如'高雄市…166號(舊市議會主婦商場)'時，只要地址的部分，括號不要。
        - 接下來，逐個描述每個職位。每個職位應包含：
        - 職位名稱(請寫完整，若一行多個職位請分開)
            -工作地點(和公司地址填一樣的，或完整特殊工作地點，同個職位多個地點(只有地點不一樣，其他內容都一樣的職位)用'、'隔開就好，特殊狀況:地點出現括號，例如'八德 (近八德區公所)'，只要地點的部分，括號不要，若都沒有請填'無')
            -工作開始與結束時間(用24小時制表示)
            -薪資上限與下限的注意事項:
            1.若是給只有定一個數字，例如'薪28000'、'時薪200'、'月薪32000元'、'2000'，則薪資上限和下限"都要"填上該數字。
            2.若遇到'時薪183元起'、'27470+獎金'、'1700以上'等情況，就填數字在'薪資下限'，'薪資上限'填'無'。
            -薪資方式(圖片中若出現'薪資面議'、'面議'等字詞屬於下一個步驟的'其他資訊'，此時”薪資上下限”和”薪資方式”填"無")。
            - 若每個職位的條件相似但時間不同，仍需單獨列出，並且剩餘資訊不可忽略。
            - 任何其他屬於該職位的資訊，(注意:不要更改原始敘述方式，例如:'/'；若有多項，請以'、'區隔)，勿加入與職位和工作無關的資訊，例如'誠徵'、'Line Id'、'意洽'、'鄭經理'、'陳小姐'、'孫先生'、'月入幾萬不是夢'、'財富自由'、'無誠勿擾'、'見報一週內有效'等。
        - 最後，請查看是否有適用於所有職位的其他資訊，如福利條件，並將此類資訊重複放在每個職位的'其他資訊'欄中，如果資訊位置靠近特定職位，請仔細推敲其是否只有適用於該職位。

        您的回應必須使用#zh-tw，並以正確的JSON格式呈現，如下所示：
        {
            “公司名稱”: “<公司名稱或'無'>”, 
            “聯絡電話”: [“<只可填電話(忽略人名)，若不同區域請特別註明區域與電話，或'無'>”],
            “公司地址”: “<公司地址或'無'>”,
            “職位”: [
                {
                    “職位名稱”: “<職位名稱>”,
                    “工作地點”: “<公司地址或特殊工作地點，若都沒有填'無'>”,
                    “工作開始時間”: “<用24小時制表示或'無'>”,
                    “工作結束時間”: “<用24小時制表示或'無'>”,
                    “薪資下限”: “<薪資下限或'無'>”,
                    “薪資上限”: “<薪資上限或'無'>”,
                    “薪資方式”: “<'時薪'、'日薪'、'月薪'或'無'>”,
                    “其他資訊”: “<任何其他屬於該職位的資訊(注意:不要更改原始敘述方式，例如:'/'；若有多項，請以'、'區隔)或'無'>”
                },
                …
            ],
        }
        全部都生成後，請重新檢查是否與原始內容完全一致，以及職位與工作地點是否需排列組合，以及其他資訊有沒有搞混特定職位專屬，或是所有職位都適用。
        """,
                "image": f"/home/at0505/chuang-rsv1/dataset_all/{row['file_name']}.jpg"
            }
            # 解析 result 字段为 JSON
            result = json.loads(row['result'])
            assistant_message = {
                "role": "assistant",
                "content": json.dumps(result, ensure_ascii=False)
            }
            # 將每條紀錄写入 JSONL 文件
            json_line = {"messages": [user_message, assistant_message]}
            f.write(json.dumps(json_line, ensure_ascii=False) + '\n')

    print(f"已成功轉換並保存到 {output_path}")

# 轉換數據並保存為 JSONL 文件
input_file = r"D:\s_cvplan\label\label_0120.xlsx"  # 輸入的 Excel 文件路徑
output_file = "text.jsonl"  # 輸出的 JSONL 文件路徑
xlsx_to_jsonl(input_file, output_file)
